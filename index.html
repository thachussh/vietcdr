<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công cụ Tạo Rubric</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React CDN -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <!-- docx for Word export (CDN mới) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@latest/build/index.min.js"></script>
  <!-- FileSaver for saving files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root" className="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Kiểm tra nếu docx có tồn tại
    if (!window.docx) {
      console.error("Thư viện docx không được tải. Vui lòng kiểm tra kết nối hoặc CDN.");
      alert("Không thể tải thư viện docx. Vui lòng kiểm tra kết nối hoặc thử lại sau.");
    }

    const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, BorderStyle } = window.docx || {};

    const App = () => {
      const [criteria, setCriteria] = useState([
        { name: "", levels: ["", "", "", ""] },
      ]);
      const [title, setTitle] = useState("Tiêu chí đánh giá");
      const [description, setDescription] = useState("Mô tả rubric...");
      const [levelLabels, setLevelLabels] = useState(["Xuất sắc", "Tốt", "Đạt", "Chưa đạt"]);

      const addCriterion = () => {
        setCriteria([...criteria, { name: "", levels: ["", "", "", ""] }]);
      };

      const updateCriterion = (index, field, value) => {
        const newCriteria = [...criteria];
        if (field === "name") {
          newCriteria[index].name = value;
        } else {
          newCriteria[index].levels[field] = value;
        }
        setCriteria(newCriteria);
      };

      const updateLevelLabel = (index, value) => {
        const newLabels = [...levelLabels];
        newLabels[index] = value;
        setLevelLabels(newLabels);
      };

      const exportToWord = () => {
        if (!window.docx) {
          alert("Thư viện docx không được tải. Vui lòng kiểm tra kết nối hoặc thử lại sau.");
          return;
        }

        try {
          const doc = new Document({
            sections: [
              {
                properties: {},
                children: [
                  new Paragraph({
                    children: [
                      new TextRun({
                        text: title,
                        bold: true,
                        size: 32,
                      }),
                    ],
                    spacing: { after: 200 },
                  }),
                  new Paragraph({
                    children: [
                      new TextRun({
                        text: description,
                        size: 24,
                      }),
                    ],
                    spacing: { after: 400 },
                  }),
                  new Table({
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    rows: [
                      new TableRow({
                        children: [
                          new TableCell({
                            children: [new Paragraph({ text: "Tiêu chí" })],
                            borders: {
                              top: { style: BorderStyle.SINGLE, size: 1 },
                              bottom: { style: BorderStyle.SINGLE, size: 1 },
                              left: { style: BorderStyle.SINGLE, size: 1 },
                              right: { style: BorderStyle.SINGLE, size: 1 },
                            },
                          }),
                          ...levelLabels.map((label) => (
                            new TableCell({
                              children: [new Paragraph({ text: label })],
                              borders: {
                                top: { style: BorderStyle.SINGLE, size: 1 },
                                bottom: { style: BorderStyle.SINGLE, size: 1 },
                                left: { style: BorderStyle.SINGLE, size: 1 },
                                right: { style: BorderStyle.SINGLE, size: 1 },
                              },
                            })
                          )),
                        ],
                      }),
                      ...criteria.map((criterion) => (
                        new TableRow({
                          children: [
                            new TableCell({
                              children: [new Paragraph({ text: criterion.name })],
                              borders: {
                                top: { style: BorderStyle.SINGLE, size: 1 },
                                bottom: { style: BorderStyle.SINGLE, size: 1 },
                                left: { style: BorderStyle.SINGLE, size: 1 },
                                right: { style: BorderStyle.SINGLE, size: 1 },
                              },
                            }),
                            ...criterion.levels.map((level) => (
                              new TableCell({
                                children: [new Paragraph({ text: level })],
                                borders: {
                                  top: { style: BorderStyle.SINGLE, size: 1 },
                                  bottom: { style: BorderStyle.SINGLE, size: 1 },
                                  left: { style: BorderStyle.SINGLE, size: 1 },
                                  right: { style: BorderStyle.SINGLE, size: 1 },
                                },
                              })
                            )),
                          ],
                        })
                      )),
                    ],
                  }),
                ],
              },
            ],
          });

          Packer.toBlob(doc).then((blob) => {
            saveAs(blob, "rubric.docx");
            console.log("Tải file Word thành công!");
          }).catch((error) => {
            console.error("Lỗi khi tạo file Word:", error);
            alert("Đã có lỗi xảy ra khi tạo file Word. Vui lòng kiểm tra console để biết thêm chi tiết.");
          });
        } catch (error) {
          console.error("Lỗi trong hàm exportToWord:", error);
          alert("Đã có lỗi xảy ra. Vui lòng kiểm tra console để biết thêm chi tiết.");
        }
      };

      return (
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h1 className="text-2xl font-bold mb-4">Công cụ Tạo Rubric</h1>
          
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Tiêu đề:</label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            />
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Mô tả:</label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
              rows="3"
            />
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Nhãn mức độ:</label>
            <div className="grid grid-cols-4 gap-2">
              {levelLabels.map((label, index) => (
                <input
                  key={index}
                  type="text"
                  value={label}
                  onChange={(e) => updateLevelLabel(index, e.target.value)}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                />
              ))}
            </div>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Tiêu chí:</label>
            {criteria.map((criterion, index) => (
              <div key={index} className="mb-4 p-4 border rounded-md">
                <input
                  type="text"
                  placeholder="Tên tiêu chí"
                  value={criterion.name}
                  onChange={(e) => updateCriterion(index, "name", e.target.value)}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm mb-2"
                />
                <div className="grid grid-cols-4 gap-2">
                  {criterion.levels.map((level, levelIndex) => (
                    <textarea
                      key={levelIndex}
                      placeholder={`Mô tả ${levelLabels[levelIndex]}`}
                      value={level}
                      onChange={(e) => updateCriterion(index, levelIndex, e.target.value)}
                      className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                      rows="2"
                    />
                  ))}
                </div>
              </div>
            ))}
            <button
              onClick={addCriterion}
              className="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              Thêm tiêu chí
            </button>
          </div>

          <div className="mt-4">
            <button
              onClick={exportToWord}
              className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              Xuất Word
            </button>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>